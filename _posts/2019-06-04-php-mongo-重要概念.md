---
layout:     post
title:      "mongodb 维护"
subtitle:   "mongodb 维护 优化"
date:       2018-12-19 12:00:00
author:     "Ikin"
catalog: php
tags:
    - php
    - mongo
---
### 文件系统 http://rdcqii.hundsun.com/portal/article/703.html
###【mongo磁盘回收】

▲ GridFs不会自动处理md5值相同的文件，也就是说，同一个文件进行两次put命令，将会在GridFS中对应两个不同的存储，对于存储来说，这是一种浪费。对于md5相同的文件，如果想要在GridFS中只有一个存储，需要通过API进行扩展处理。

▲ MongoDB 不会释放已经占用的硬盘空间。即使删除db中的集合 MongoDB也不会释放磁盘空间。同样，如果使用GridFS存储文件，从GridFS存储中删除无用的垃圾文件，MongoDB依然不会释放磁盘空间的。这会造成磁盘一直在消耗，而无法回收利用的问题。

那么怎样才能释放磁盘空间呢？

（1）可以通过修复数据库来回收磁盘空间，即在mongo shell中运行db.repairDatabase()命令或者db.runCommand({ repairDatabase: 1 })命令。（此命令执行比较慢）。

使用通过修复数据库方法回收磁盘时需要注意，待修复磁盘的剩余空间必须大于等于存储数据集占用空间加上2G，否则无法完成修复。因此使用GridFS大量存储文件必须提前考虑设计磁盘回收方案，以解决mongoDB磁盘回收问题。

（2）使用dump & restore方式，即先删除mongoDB数据库中需要清除的数据，然后使用mongodump备份数据库。数据量大会变慢，此方法不用停业务，dump完再脚本补充数据就可
 
 (3) db.runCommand({compact:"collection_name"}) 此方法为collection级别的回收，会锁住colection的所有操作，特定场景也不大适用
